<head>
	<style>
		.center{
			text-align: center;
		}
		.s{
			margin-top: 11px;
		}
		.s1{
			width: 48%;
			height: 91%;
			border: 1px solid lightgray;
			overflow: auto;
			display: inline-block;
		}
		.s1 textarea{
			min-width: 100%;
			height: 100%;
			border: 1px solid lightgray;
			outline: none;
		}
		.setting-div{
			position: fixed;
			top: 8px;
			right: 11px;
			width: 236px;
			cursor: pointer;
		}
		#setting{
			background-color: white;
			padding: 8px;
		}
		.setting-title{
			background-color: lightgray;
		}
		.setting-div label{
			display: inline-block;
			width: 50px;
			
		}
		.setting-btn{
			position: relative;
			left: 190px;
		}
	</style>
</head>
<body>
	<div class="center">
		<input id="img" type="file"/>
	</div>
	<div class="setting-div">
		<div class="center setting-title" onclick="showSetting()">
			↓↑
		</div>
		<div id="setting" style="display: none;">
			<label>r</label><input id="r" type="text" value="100"/><br/>
			<label>g</label><input id="g" type="text" value="100"/><br/>
			<label>b</label><input id="b" type="text" value="100"/><br/>
			<label>a</label><input id="a" type="text" value="0.5"/><br/>
			<label>hh</label><input id="hh" type="text" value="5"/><br/>
			<label>dense</label><input id="dense" type="text" value="2"/><br/>
			<label>revert</label>
			<select id="revert">
				<option value="0">false</option>
				<option value="1">true</option>
			</select>
			<br/>
			<input class="setting-btn" onclick="todo()" type="button" value=">>">
		</div>
	</div>
	<div class="center s">
		<div class="s1">
			<canvas id="canvas">
		</canvas>
		</div>
		<div class="s1">
			<textarea id="area" readonly></textarea>
		</div>
	</div>
	<script>
		var iFile=document.getElementById('img');
		var canvas=document.getElementById('canvas');
		var area=document.getElementById('area');
		
		var imgWidth = 0;
		var imgHeight = 0;
		var imgdata;
		
		var bg1 = '@';
		var bg2 = ' ';
		
		var rV;
		var gV;
		var bV;
		var aV;
		var hhV;
		var denseV;
		var revertV;

		iFile.addEventListener("change", function (e) {
			var img = e.target.files[0];

			if (!img) {
				alert("select image");
				return;
			}

			if (!(img.type.indexOf('image') == 0 && img.type && /\.(?:jpg|jpeg|png|gif)$/i.test(img.name))){
				alert("select image");
				return;
			}

			if (img.size > 500 * 1024){
				 //alert('<500K');
				 //return;
			}

			var image = new Image()
			image.src = window.URL.createObjectURL(img)
			image.onload = function () {
			getImageData(this);
			getRgba()

			}
		})
		
		function showSetting(){
			var tag = document.getElementById('setting');
			if(tag.style.display == 'none'){
				tag.style.display = 'block';
			}else{
				tag.style.display = 'none';
			}
		}
		
		function todo(){
			getRgba();
		}
		
		function getImageData(that){
			imgWidth = that.width;
			imgHeight = that.height;
			console.log('img:', imgWidth + '/' + imgHeight + '/' + length);
			var context = canvas.getContext('2d');
			canvas.width = imgWidth;
			canvas.height = imgHeight;
			context.drawImage(that, 0, 0, imgWidth, imgHeight);
			var imgdatas = context.getImageData(0, 0, imgWidth, imgHeight);
			imgdata = imgdatas.data;
		}

		function getRgba() {
		
			var rT = document.getElementById('r').value;
			var gT = document.getElementById('g').value;
			var bT = document.getElementById('b').value;
			var aT = document.getElementById('a').value;
			var hhT = document.getElementById('hh').value;
			var denseT = document.getElementById('dense').value;
			var revertT = document.getElementById('revert').value;
			
			rV = rT?parseInt(rT):100;
			gV = gT?parseInt(gT):100;
			bV = bT?parseInt(bT):100;
			aV = aT?parseFloat(aT):0.5;
			hhV = hhT?parseInt(hhT):5;
			denseV = denseT?parseInt(denseT):2;
			revertV = revertT=='1'?true:false;
		
			var length = imgdata.length;
			var matrix = [];
			var heightIndex = -1;
			for (var i = 0; i < length; i++) {
				if (i % 4 == 0) {
					var r = imgdata[i];
					var g = imgdata[i + 1];
					var b = imgdata[i + 2];
					var a = Math.round(imgdata[i + 3] / 255 * 100) / 100;

					var rgba = [r,g,b,a];
					if(i/4%imgWidth == 0){
						heightIndex++;
						matrix[heightIndex] = [];
					}
					matrix[heightIndex].push(rgba);
				}
				
			}
			console.log(matrix);
			draw(matrix);
		}

		function draw(matrix){
			var content = '';
			var flag1 = 0,flag2 = 0;
			for(var i=0;i<matrix.length;i = i + hhV){
				var line = matrix[i];
				for(var j=0;j<line.length;j++){
					if(checkColor(matrix, i, j)){
						flag1 = flag1 + 1;
						flag2 = 0;
						if(flag1 >= denseV){
							flag1 = 0;
							content = content + (revertV?bg2:bg1);
						}
					}else{
						flag2 = flag2 + 1;
						flag1 = 0;
						if(flag2 >= denseV){
							flag2 = 0;
							content = content + (revertV?bg1:bg2);
						}
						
					}
				}
				content = content + '\n';
			}
			var areaWidth = matrix[0].length/2*6;
			area.style.width = areaWidth + 'px';
			area.value = content;
		}
		
		function checkColor(matrix, i, j){
			for(var a=0;a<hhV;a++){
				var line = matrix[i+a];
				if(line){
					var rgba = line[j];
					if((rgba[0] < rV && rgba[1] < gV && rgba[2] < bV) && rgba[3] > aV){
						return true;
					}
				}
			}
			return false;
		}
		
	</script>
</body>